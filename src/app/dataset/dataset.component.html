<app-load-animation
  *ngIf="datasetIsLoading || harvestIsLoading || workflowIsLoading || lastExecutionIsLoading"
  [resources]="{
    dataset: !datasetData,
    'harvest data': harvestIsLoading,
    workflow: workflowIsLoading,
    'last workflow': lastExecutionIsLoading
  }"
></app-load-animation>

<app-reportsimple
  [reportErrors]="reportErrors"
  [reportMsg]="reportMsg"
  [reportLoading]="reportLoading"
  (closeReportSimple)="clearReport()"
>
</app-reportsimple>

<div
  class="dashboard-wrapper"
  *ngIf="!datasetIsLoading && !harvestIsLoading && !workflowIsLoading && !lastExecutionIsLoading"
>
  <app-notification
    *ngIf="notification"
    [notification]="notification"
    (closed)="notification = undefined"
  ></app-notification>

  <div *ngIf="datasetData">
    <div class="dataset-collapse-blocks metis-dashboard">
      <div class="metis-dashboard-left">
        <app-generalinfo
          [datasetData]="datasetData"
          [harvestPublicationData]="harvestPublicationData"
        ></app-generalinfo>
      </div>
      <div class="metis-dashboard-right">
        <div *ngIf="datasetData.publicationFitness === 'UNFIT'" class="unfit-to-publish">
          {{ 'datasetUnpublishableBanner' | translate }}
        </div>
        <div *ngIf="datasetData.publicationFitness === 'PARTIALLY_FIT'" class="unfit-to-publish">
          {{ 'datasetPartiallyUnpublishableBanner' | translate }}
        </div>
        <app-actionbar
          [datasetId]="datasetId"
          [datasetName]="datasetName"
          [workflowData]="workflowData"
          [lastExecutionData]="lastExecutionData"
          [isStarting]="isStarting"
          [showPluginLog]="showPluginLog"
          (setShowPluginLog)="showPluginLog = $event"
          (startWorkflow)="startWorkflow()"
          (setReportMsg)="setReportMsg($event)"
        ></app-actionbar>
        <app-lastexecution
          [datasetId]="datasetId"
          [lastExecutionData]="lastExecutionData"
          (setReportMsg)="setReportMsg($event)"
        ></app-lastexecution>
        <app-datasetlog
          *ngIf="showPluginLog"
          [showPluginLog]="showPluginLog"
          (closed)="showPluginLog = undefined"
        ></app-datasetlog>
      </div>
    </div>

    <div class="tabbed-content" #scrollToTopAnchor>
      <ul class="tabs">
        <li [ngClass]="{ active: activeTab === 'edit' }">
          <a routerLink="/dataset/edit/{{ datasetId }}">
            <span class="tab-title">{{ 'datasetInformation' | translate }}</span>
            <span class="tab-subtitle">{{ 'lastHarvest' | translate }}</span>
            <span class="tab-subtitle tab-date" *ngIf="harvestPublicationData">{{
              harvestPublicationData.lastHarvestedDate | date: 'dd/MM/yyyy - HH:mm'
            }}</span>
          </a>
        </li>
        <li [ngClass]="{ active: activeTab === 'workflow' }">
          <a routerLink="/dataset/workflow/{{ datasetId }}">
            <span class="tab-title">{{ 'workflow' | translate }}</span>
          </a>
        </li>
        <li [ngClass]="{ active: activeTab === 'mapping' }">
          <a routerLink="/dataset/mapping/{{ datasetId }}">
            <span class="tab-title">{{ 'mapping' | translate }}</span>
          </a>
        </li>
        <li [ngClass]="{ active: activeTab === 'preview' }">
          <a routerLink="/dataset/preview/{{ datasetId }}">
            <span class="tab-title">{{ 'rawXml' | translate }}</span>
          </a>
        </li>
        <li [ngClass]="{ active: activeTab === 'log' }">
          <a routerLink="/dataset/log/{{ datasetId }}">
            <span class="tab-title">{{ 'processingHistory' | translate }}</span>
            <span class="tab-subtitle">{{ 'lastModified' | translate }}</span>
            <span class="tab-subtitle tab-date" *ngIf="lastExecutionData">{{
              lastExecutionData.updatedDate | date: 'dd/MM/yyyy - HH:mm'
            }}</span>
          </a>
        </li>
      </ul>
    </div>

    <app-workflow-header
      (returnToTop)="returnToTop()"
      (setLinkCheck)="setLinkCheck($event)"
      [conf]="fieldConf"
      *ngIf="activeTab === 'workflow'"
    >
    </app-workflow-header>

    <div class="tab-content">
      <app-datasetform
        *ngIf="activeTab === 'new' || activeTab === 'edit'"
        [datasetData]="datasetData"
        [harvestPublicationData]="harvestPublicationData"
        [isNew]="false"
        (datasetUpdated)="loadData()"
      ></app-datasetform>
      <app-workflow
        *ngIf="activeTab === 'workflow'"
        [datasetData]="datasetData"
        [fieldConf]="fieldConf"
        [workflowData]="workflowData"
        [lastExecution]="lastExecutionData"
        [isStarting]="isStarting"
        (startWorkflow)="startWorkflow()"
        (formInitialised)="formInitialised($event)"
      ></app-workflow>
      <app-mapping
        *ngIf="activeTab === 'mapping'"
        [datasetData]="datasetData"
        (setTempXSLT)="tempXSLT = $event"
      ></app-mapping>
      <app-preview
        *ngIf="activeTab === 'preview'"
        [datasetData]="datasetData"
        [previewFilters]="previewFilters"
        [tempXSLT]="tempXSLT"
        (setPreviewFilters)="previewFilters = $event"
      ></app-preview>
      <app-history
        *ngIf="activeTab === 'log'"
        [datasetData]="datasetData"
        [lastExecutionData]="lastExecutionData"
        (setReportMsg)="setReportMsg($event)"
        (setPreviewFilters)="previewFilters = $event"
      ></app-history>
    </div>
  </div>
</div>
