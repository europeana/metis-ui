<div class="wizard">
  <div class="wizard-head" [ngClass]="{ 'dataset-orbs-hidden': datasetOrbsHidden }">
    <ng-container *ngFor="let stepConf of wizardConf; let i = index" [ngSwitch]="stepConf.stepType">
      <label *ngIf="currentStepIndex === i">
        <ng-container
          *ngSwitchCase="EnumWizardStepType.SET_NAME"
          i18n="upload step title@@enterName"
        >
          Enter a Dataset Name
        </ng-container>
        <ng-container
          *ngSwitchCase="EnumWizardStepType.SET_LANG_LOCATION"
          i18n="upload step title@@enterDetails"
        >
          Enter the Dataset Details
        </ng-container>
        <ng-container
          *ngSwitchCase="EnumWizardStepType.PROTOCOL_SELECT"
          i18n="upload step title@@configureSource"
        >
          Configure the Data Source
        </ng-container>
        <ng-container
          *ngSwitchCase="EnumWizardStepType.PROGRESS_TRACK"
          i18n="upload step title@@trackProcessing"
        >
          Track Dataset Processing
        </ng-container>
        <ng-container *ngSwitchCase="EnumWizardStepType.REPORT" i18n="upload step title@@report">
          Record Report
        </ng-container>
      </label>
    </ng-container>

    <sb-navigation-orbs
      [count]="wizardConf.length"
      [fnClassMapOuter]="getNavOrbConfigOuter.bind(this)"
      [fnClassMapInner]="getNavOrbConfigInner.bind(this)"
      (clickEvent)="setStep($event)"
    ></sb-navigation-orbs>
  </div>
  <div class="wizard-content">
    <form [formGroup]="formUpload">
      <div
        [ngClass]="{
          active: wizardConf[currentStepIndex].stepType === EnumWizardStepType.SET_NAME
        }"
        class="form-group wizard-section"
      >
        <label for="name" i18n="name label">Name</label>
        <input id="name" formControlName="name" autocomplete="off" />
        <span class="field-errors" *ngIf="formUpload.get('name')?.errors">
          <span class="errors" i18n="Field error@@invalidDatasetName"
            >Please provide a valid name</span
          >
        </span>
      </div>

      <div
        [ngClass]="{
          active: wizardConf[currentStepIndex].stepType === EnumWizardStepType.SET_LANG_LOCATION
        }"
        class="form-group wizard-section"
      >
        <label for="country" i18n="country label">Country</label>
        <select id="country" formControlName="country">
          <option *ngFor="let option of countryList" [ngValue]="option.name">{{
            option.xmlValue
          }}</option>
        </select>
      </div>

      <div
        [ngClass]="{
          active: wizardConf[currentStepIndex].stepType === EnumWizardStepType.SET_LANG_LOCATION
        }"
        class="form-group wizard-section"
      >
        <label for="language" i18n="language label">Language</label>
        <select id="language" formControlName="language">
          <option *ngFor="let option of languageList" [ngValue]="option.name">{{
            option.xmlValue
          }}</option>
        </select>
      </div>

      <div
        [ngClass]="{
          active: wizardConf[currentStepIndex].stepType === EnumWizardStepType.PROTOCOL_SELECT
        }"
        class="form-group wizard-section"
      >
        <lib-protocol-field-set
          #protocolFields
          [protocolForm]="formUpload"
          [incrementalEnabled]="false"
          [protocolSwitchField]="'uploadProtocol'"
          visibleProtocols="[EnumProtocolType.ZIP_UPLOAD, EnumProtocolType.HTTP_HARVEST, EnumProtocolType.OAIPMH_HARVEST]"
          [fileFormName]="zipFileFormName"
        >
        </lib-protocol-field-set>
        <label>
          <input
            type="checkbox"
            (change)="updateConditionalXSLValidator()"
            [formGroup]="formUpload"
            formControlName="sendXSLT"
          />Apply XSL transformation to harvested records
        </label>
        <div [ngClass]="{ hidden: !formUpload.value.sendXSLT }">
          <lib-file-upload
            #xslFileField
            [formControlName]="xsltFileFormName"
            [form]="formUpload"
            [acceptedTypes]="'.xsl'"
            ngDefaultControl
          ></lib-file-upload>
        </div>
      </div>
    </form>

    <form
      [ngClass]="{
        active: getIsProgressTrack(currentStepIndex)
      }"
      [formGroup]="formProgress"
      (ngSubmit)="onSubmitProgress(true)"
      class="wizard-section"
    >
      <sb-progress-tracker
        *ngIf="progressData"
        [progressData]="progressData"
        [datasetId]="trackDatasetId"
        [isLoading]="isPollingProgress"
      ></sb-progress-tracker>
    </form>

    <div
      [ngClass]="{ active: getIsRecordTrack(currentStepIndex) }"
      [formGroup]="formRecord"
      class="wizard-section"
      *ngIf="recordReport"
    >
      <sb-record-report [report]="recordReport"></sb-record-report>
    </div>

    <form
      [ngClass]="{
        active: getIsProgressTrackOrReport(currentStepIndex)
      }"
      [formGroup]="formProgress"
      (ngSubmit)="onSubmitProgress(true)"
      class="wizard-section"
    >
      <div class="form-group">
        <label i18n="track id label" for="dataset-to-track"
          >Enter the id of a dataset to track
        </label>
        <div class="submit-id-ctrls" [ngClass]="getConnectClasses('top')">
          <input
            formControlName="datasetToTrack"
            data-e2e="datasetToTrack"
            autofocus
            autocomplete="off"
            id="dataset-to-track"
          />
          <button
            type="submit"
            class="submit"
            [disabled]="!formProgress.valid"
            data-e2e="submitProgress"
            i18n="track button|submits the track id button@@submitTrackId"
          >
            track
          </button>
        </div>
        <ng-container *ngIf="formProgress.get('datasetToTrack')?.errors; let errors">
          <span class="field-errors" *ngIf="errors.invalid">
            <span class="errors" i18n="Field error@@invalidDatasetId"
              >Please provide a valid dataset id</span
            >
          </span>
        </ng-container>
      </div>
    </form>

    <form
      [formGroup]="formRecord"
      *ngIf="getIsProgressTrackOrReport()"
      (ngSubmit)="onSubmitRecord(true)"
    >
      <div class="form-group">
        <label i18n="track id label" for="record-to-track">Enter the id of a record</label>
        <div class="submit-id-ctrls" [ngClass]="getConnectClasses('bottom')">
          <input
            formControlName="recordToTrack"
            data-e2e="recordToTrack"
            autocomplete="off"
            id="record-to-track"
          />
          <button
            [ngClass]="{ hidden: false }"
            [disabled]="!formRecord.valid"
            class="submit"
            i18n="report button|submits the record id button@@submitRecordId"
            data-e2e="submitRecord"
            type="submit"
          >
            report
          </button>
        </div>
        <ng-container *ngIf="formRecord.get('recordToTrack')?.errors; let errors">
          <span class="field-errors" *ngIf="errors.invalid; let errors">
            <span class="errors" i18n="Field error@@invalidRecordId"
              >Please provide a valid record id</span
            >
          </span>
        </ng-container>
      </div>
    </form>

    <form class="buttons" [formGroup]="formUpload">
      <ng-container *ngIf="getIsProgressTrackOrReport()">
        <ul>
          <li *ngIf="getIsRecordTrack(currentStepIndex)">
            <label class="inline-text"
              >Or
              <a
                class="link-internal"
                (click)="fillAndSubmitProgressForm()"
                data-e2e="link-progress-form"
                >track a dataset</a
              ></label
            >
          </li>
          <li>
            <label class="inline-text" i18n="create link link@@createLinkInternal"
              >Or
              <a class="link-internal" (click)="setStep(0, true)" data-e2e="link-dataset-form"
                >create a new dataset</a
              ></label
            >
          </li>
        </ul>
      </ng-container>
      <button
        [ngClass]="{ hidden: datasetOrbsHidden || getIsProgressTrackOrReport(currentStepIndex) }"
        [disabled]="!formUpload.valid"
        data-e2e="submit-upload"
        class="submit"
        (click)="onSubmitDataset()"
        i18n="Submit button|uploads the dataset button@@submitDataset"
      >
        Submit
      </button>

      <div [ngClass]="{ hidden: datasetOrbsHidden }">
        <button
          class="nav-orb labelled previous"
          [ngClass]="{ hidden: !canGoToPrevious() }"
          (click)="setStep(currentStepIndex - 1)"
        ></button>
        <button
          class="nav-orb labelled next"
          [ngClass]="{ hidden: !canGoToNext() }"
          (click)="setStep(currentStepIndex + 1)"
        ></button>
      </div>
    </form>
    <div *ngIf="error" class="errors">
      <div class="heading">
        {{ error.statusText }}
      </div>
      <ul class="error-detail">
        <li>{{ error.message }}</li>
      </ul>
    </div>
  </div>
</div>
