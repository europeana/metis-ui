<main class="wizard">
  <div
    class="wizard-head"
    [ngClass]="{
      'dataset-orbs-hidden': wizardConf[getStepIndex(EnumWizardStepType.UPLOAD)].isHidden
    }"
  >
    <ng-container *ngFor="let stepConf of wizardConf; let i = index" [ngSwitch]="stepConf.stepType">
      <h1 class="header-text" *ngIf="currentStepIndex === i">
        <ng-container
          *ngSwitchCase="EnumWizardStepType.UPLOAD"
          i18n="upload step title@@titleConfigureSource"
        >
          Upload Dataset
        </ng-container>

        <ng-container
          *ngSwitchCase="EnumWizardStepType.PROGRESS_TRACK"
          i18n="upload step title@@titleTrackProcessing"
        >
          Track Dataset Processing
        </ng-container>
        <ng-container
          *ngSwitchCase="EnumWizardStepType.PROBLEMS_DATASET"
          i18n="upload step title@@titleProblemsDataset"
        >
          Problem Patterns (Dataset)
        </ng-container>
        <ng-container
          *ngSwitchCase="EnumWizardStepType.REPORT"
          i18n="upload step title@@titleReport"
        >
          Record Report
        </ng-container>
        <ng-container
          *ngSwitchCase="EnumWizardStepType.PROBLEMS_RECORD"
          i18n="upload step title@@titleProblemsRecord"
        >
          Problem Patterns (Record)
        </ng-container>
      </h1>
    </ng-container>

    <sb-navigation-orbs
      ariaLabel="Wizard Step Navigation"
      [count]="wizardConf.length"
      [fnClassMapOuter]="getNavOrbConfigOuter.bind(this)"
      [fnClassMapInner]="getNavOrbConfigInner.bind(this)"
      (clickEvent)="setStep($event)"
    ></sb-navigation-orbs>
  </div>
  <div class="wizard-content">
    <sb-upload
      [showing]="currentStepType === EnumWizardStepType.UPLOAD"
      (notifySubmitted)="dataUploaded($event)"
      (notifyBusy)="setBusyUpload($event)"
    >
    </sb-upload>

    <form
      [ngClass]="{
        active: currentStepType === EnumWizardStepType.PROGRESS_TRACK
      }"
      [formGroup]="formProgress"
      (ngSubmit)="onSubmitProgress($event.submitter.id, true)"
      class="wizard-section"
    >
      <sb-progress-tracker
        *ngIf="progressData"
        [progressData]="progressData"
        [datasetId]="trackDatasetId"
        [isLoading]="isPollingProgress"
      ></sb-progress-tracker>
    </form>

    <div
      [ngClass]="{
        active: currentStepType === EnumWizardStepType.PROBLEMS_DATASET
      }"
      class="wizard-section"
    >
      <sb-problem-viewer
        *ngIf="problemPatternsDataset"
        [problemPatternsDataset]="problemPatternsDataset"
        (openLinkEvent)="followProblemPatternLink($event)"
      ></sb-problem-viewer>
    </div>

    <div
      [ngClass]="{
        active: currentStepType === EnumWizardStepType.PROBLEMS_RECORD
      }"
      class="wizard-section"
    >
      <sb-problem-viewer
        *ngIf="problemPatternsRecord"
        [problemPatternsRecord]="problemPatternsRecord"
        (openLinkEvent)="followProblemPatternLink($event)"
      ></sb-problem-viewer>
    </div>

    <div
      [ngClass]="{ active: currentStepType === EnumWizardStepType.REPORT }"
      [formGroup]="formRecord"
      class="wizard-section"
      *ngIf="recordReport"
    >
      <sb-record-report [report]="recordReport"></sb-record-report>
    </div>

    <form
      [ngClass]="{
        active: currentStepType !== EnumWizardStepType.UPLOAD
      }"
      [formGroup]="formProgress"
      (ngSubmit)="onSubmitProgress($event.submitter.id, true)"
      class="wizard-section"
    >
      <div class="form-group">
        <label
          i18n="track id label"
          for="dataset-to-track"
          [ngClass]="{ asterisked: !formProgress.valid, tick: formProgress.valid }"
          >Enter the id of a dataset to track
        </label>
        <div class="submit-id-ctrls" [ngClass]="getConnectClasses('top')">
          <input
            formControlName="datasetToTrack"
            data-e2e="datasetToTrack"
            autofocus
            autocomplete="off"
            id="dataset-to-track"
          />
          <button
            type="submit"
            class="submit-button"
            [id]="ButtonAction.BTN_PROGRESS"
            [disabled]="!formProgress.valid"
            data-e2e="submitProgress"
            i18n="track button|submits the track id button@@submitTrackId"
          >
            <span class="icon track"></span>
            <span class="label">Track</span>
          </button>

          <button
            [disabled]="!formProgress.valid"
            class="submit-button"
            [id]="ButtonAction.BTN_PROBLEMS"
            i18n="dataset problems button|submits the dataset id button@@submitDatasetIdProblems"
            data-e2e="submitDatasetProblems"
            type="submit"
          >
            <span class="icon"></span>
            <span class="label">Problem Patterns</span>
          </button>
        </div>
        <ng-container *ngIf="formProgress.get('datasetToTrack')?.errors; let errors">
          <span class="field-errors" *ngIf="errors.invalid">
            <span class="errors" i18n="Field error@@invalidDatasetId"
              >Please provide a valid dataset id</span
            >
          </span>
        </ng-container>
      </div>
    </form>

    <form
      [formGroup]="formRecord"
      *ngIf="currentStepType !== EnumWizardStepType.UPLOAD"
      (ngSubmit)="onSubmitRecord($event.submitter.id, true)"
    >
      <div class="form-group">
        <label
          i18n="track id label"
          for="record-to-track"
          [ngClass]="{ asterisked: !formRecord.valid, tick: formRecord.valid }"
          >Enter the id of a record</label
        >
        <div class="submit-id-ctrls" [ngClass]="getConnectClasses('bottom')">
          <input
            formControlName="recordToTrack"
            data-e2e="recordToTrack"
            autocomplete="off"
            id="record-to-track"
          />
          <button
            [disabled]="!formRecord.valid"
            class="submit-button"
            [id]="ButtonAction.BTN_RECORD"
            i18n="report button|submits the record id button@@submitRecordId"
            data-e2e="submitRecord"
            type="submit"
          >
            <span class="icon report"></span>
            <span class="label">Report</span>
          </button>
          <button
            [disabled]="!formRecord.valid"
            class="submit-button"
            [id]="ButtonAction.BTN_PROBLEMS"
            i18n="report problems button|submits the record id button@@submitRecordIdProblems"
            data-e2e="submitRecordProblems"
            type="submit"
          >
            <span class="icon"></span>
            <span class="label">Problem Patterns</span>
          </button>
        </div>
        <ng-container *ngIf="formRecord.get('recordToTrack')?.errors; let errors">
          <span class="field-errors" *ngIf="errors.invalid; let errors">
            <span class="errors" i18n="Field error@@invalidRecordId"
              >Please provide a valid record id</span
            >
          </span>
        </ng-container>
      </div>
    </form>

    <ng-container *ngIf="currentStepType !== EnumWizardStepType.UPLOAD">
      <ul class="inline-texts">
        <li *ngIf="currentStepType !== EnumWizardStepType.PROGRESS_TRACK">
          <label class="inline-text"
            >Or
            <a
              class="link-internal"
              (click)="fillAndSubmitProgressForm(false, true)"
              data-e2e="link-progress-form"
              >track a dataset</a
            ></label
          >
        </li>
        <li>
          <label class="inline-text" i18n="create link link@@createLinkInternal"
            >Or
            <a class="link-internal" (click)="setStep(0, true)" data-e2e="link-dataset-form"
              >create a new dataset</a
            ></label
          >
        </li>
      </ul>
    </ng-container>
    <sb-http-errors [error]="wizardConf[currentStepIndex].error"></sb-http-errors>
  </div>
</main>
